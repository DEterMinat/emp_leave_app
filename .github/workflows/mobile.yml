name: Mobile CI/CD

on:
  push:
    branches: [ "master", "main" ]
  pull_request:
    branches: [ "master", "main" ]

jobs:
  quality-and-build:
    name: Build & Quality Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸš€ Checkout Code
      uses: actions/checkout@v4
    
    - name: ğŸ› ï¸ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: 'latest'
        channel: 'stable'
        cache: true # Built-in caching for Flutter SDK
        
    - name: ğŸ“¦ Cache Pub Packages
      uses: actions/cache@v4
      with:
        path: ~/.pub-cache
        key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
        restore-keys: |
          ${{ runner.os }}-pub-

    - name: ğŸ“¥ Get Dependencies
      run: flutter pub get
      
    - name: ğŸ” Static Analysis
      run: flutter analyze
      
    - name: ğŸ§ª Run Unit Tests
      run: flutter test --coverage
      
    - name: ğŸ“± Build Android APK (Release)
      run: flutter build apk --release
      
    - name: ğŸŒ Build Flutter Web
      run: flutter build web --release

    - name: ğŸ“¤ Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: android-release
        path: build/app/outputs/flutter-apk/app-release.apk
        retention-days: 7

    - name: ğŸ“¤ Upload Web Artifact
      uses: actions/upload-artifact@v4
      with:
        name: web-release
        path: build/web
        retention-days: 7

    - name: ğŸ³ Build Docker Image (Web)
      run: docker build -t emp-leave-mobile:latest ./Mobile/emp_leave_app
